---
about_this_resource_text: ''
course_id: 6-004-computation-structures-spring-2017
embedded_media:
- id: Video-YouTube-Stream
  media_location: Sqhb-TGC4aQ
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: Video-YouTube-Stream
  type: Video
  uid: 2a9b7d20bb464da46c276f40e11287bd
- id: 3Play-3Play YouTube id-Stream
  media_location: Sqhb-TGC4aQ
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: 3Play-3Play YouTube id
  type: 3Play
  uid: 1f48ec2319041a659e980a9736d8abc7
- id: Thumbnail-YouTube-JPG
  media_location: https://img.youtube.com/vi/Sqhb-TGC4aQ/default.jpg
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: Thumbnail-YouTube-JPG
  type: Thumbnail
  uid: 5256799d5fd52a9bce5f8633df080c07
- id: Sqhb-TGC4aQ.srt
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-004-computation-structures-spring-2017/c11/c11s2/c11s2v2/compiling-expressions-8-34-/Sqhb-TGC4aQ.srt
  title: 3play caption file
  type: null
  uid: 22d1b869b84d45fe6bb4fb87e16ed86a
- id: Sqhb-TGC4aQ.pdf
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-004-computation-structures-spring-2017/c11/c11s2/c11s2v2/compiling-expressions-8-34-/Sqhb-TGC4aQ.pdf
  title: 3play pdf file
  type: null
  uid: 6b3a8920e776a4a388d1395c39605b79
- id: Caption-3Play YouTube id-SRT
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: Caption-3Play YouTube id-SRT-English - US
  type: Caption
  uid: c5af383355869afedb1b4c5eb3d6c676
- id: Transcript-3Play YouTube id-PDF
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: Transcript-3Play YouTube id-PDF-English - US
  type: Transcript
  uid: b3705ea2ba62954f9147fc90ed67eccb
- id: Video-InternetArchive-MP4
  media_location: https://archive.org/download/MIT6.004S17/MIT6_004S17_11-02-02_300k.mp4
  parent_uid: cb34fd077ec52ee1979a08a2df3bdcfe
  title: Video-Internet Archive-MP4
  type: Video
  uid: dd440e2761dffa490afe5d43f812784c
inline_embed_id: 13668883compilingexpressions83449442019
layout: video
order_index: null
parent_uid: d66965fd83fac1e9160cd41afaa31671
related_resources_text: ''
short_url: compiling-expressions-8-34-
technical_location: https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-004-computation-structures-spring-2017/c11/c11s2/c11s2v2/compiling-expressions-8-34-
template_type: Embed
title: Compiling Expressions (8:34)
transcript: <p><span m='979'>A</span> <span m='1316'>compiler</span> <span m='1653'>is</span>
  <span m='1990'>a</span> <span m='2327'>program</span> <span m='2665'>that</span>
  <span m='3002'>translates</span> <span m='3339'>a</span> <span m='3676'>high-level</span>
  <span m='4013'>language</span> <span m='4351'>program</span> <span m='4688'>into</span>
  <span m='5025'>a</span> <span m='5362'>functionally</span> <span m='5700'>equivalent</span>
  <span m='6181'>sequence</span> <span m='6663'>of</span> <span m='7145'>machine</span>
  <span m='7627'>instructions,</span> <span m='8109'>i.e.,</span> <span m='8591'>an</span>
  <span m='9073'>assembly</span> <span m='9555'>language</span> <span m='10037'>program.</span>
  </p><p><span m='10519'>A</span> <span m='10907'>compiler</span> <span m='11296'>first</span>
  <span m='11684'>checks</span> <span m='12073'>that</span> <span m='12461'>the</span>
  <span m='12850'>high-level</span> <span m='13239'>program</span> <span m='13627'>is</span>
  <span m='14016'>correct,</span> <span m='14404'>i.e.,</span> <span m='14793'>that</span>
  <span m='15181'>the</span> <span m='15570'>statements</span> <span m='15959'>are</span>
  <span m='16409'>well</span> <span m='16859'>formed,</span> <span m='17309'>the</span>
  <span m='17759'>programmer</span> <span m='18209'>isn't</span> <span m='18659'>asking</span>
  <span m='19109'>for</span> <span m='19559'>nonsensical</span> <span m='20009'>computations,</span>
  <span m='20460'>e.g.,</span> <span m='20794'>adding</span> <span m='21128'>a</span>
  <span m='21462'>string</span> <span m='21796'>value</span> <span m='22130'>and</span>
  <span m='22464'>an</span> <span m='22798'>integer,</span> <span m='23132'>or</span>
  <span m='23467'>attempting</span> <span m='23801'>to</span> <span m='24135'>use</span>
  <span m='24469'>the</span> <span m='24803'>value</span> <span m='25137'>of</span>
  <span m='25471'>a</span> <span m='25805'>variable</span> <span m='26140'>before</span>
  <span m='26558'>it</span> <span m='26976'>has</span> <span m='27395'>been</span>
  <span m='27813'>properly</span> <span m='28231'>initialized.</span> <span m='28650'>The</span>
  <span m='29068'>compiler</span> <span m='29487'>may</span> <span m='29905'>also</span>
  <span m='30323'>provide</span> <span m='30742'>warnings</span> <span m='31160'>when</span>
  <span m='31579'>operations</span> <span m='32020'>may</span> <span m='32462'>not</span>
  <span m='32903'>produce</span> <span m='33345'>the</span> <span m='33787'>expected</span>
  <span m='34228'>results,</span> <span m='34670'>e.g.,</span> <span m='35111'>when</span>
  <span m='35553'>converting</span> <span m='35995'>from</span> <span m='36436'>a</span>
  <span m='36878'>floating-point</span> <span m='37320'>number</span> <span m='37605'>to</span>
  <span m='37890'>an</span> <span m='38175'>integer,</span> <span m='38461'>where</span>
  <span m='38746'>the</span> <span m='39031'>floating-point</span> <span m='39317'>value</span>
  <span m='39602'>may</span> <span m='39887'>be</span> <span m='40172'>too</span>
  <span m='40458'>large</span> <span m='40743'>to</span> <span m='41028'>fit</span>
  <span m='41314'>in</span> <span m='41599'>the</span> <span m='41884'>number</span>
  <span m='42170'>of</span> <span m='42550'>bits</span> <span m='42930'>provided</span>
  <span m='43310'>by</span> <span m='43690'>the</span> <span m='44070'>integer.</span>
  <span m='44450'>If</span> <span m='44830'>the</span> <span m='45210'>program</span>
  <span m='45590'>passes</span> <span m='45970'>scrutiny,</span> <span m='46350'>the</span>
  <span m='46730'>compiler</span> <span m='47110'>then</span> <span m='47549'>proceeds</span>
  <span m='47989'>to</span> <span m='48429'>generate</span> <span m='48869'>efficient</span>
  <span m='49309'>sequences</span> <span m='49749'>of</span> <span m='50189'>instructions,</span>
  <span m='50629'>often</span> <span m='51069'>finding</span> <span m='51509'>ways</span>
  <span m='51949'>to</span> <span m='52389'>rearrange</span> <span m='52829'>the</span>
  <span m='53321'>computation</span> <span m='53814'>so</span> <span m='54307'>that</span>
  <span m='54800'>the</span> <span m='55293'>resulting</span> <span m='55785'>sequences</span>
  <span m='56278'>are</span> <span m='56771'>shorter</span> <span m='57264'>and</span>
  <span m='57757'>faster.</span> </p><p><span m='58250'>It's</span> <span m='58580'>hard</span>
  <span m='58911'>to</span> <span m='59241'>beat</span> <span m='59572'>a</span> <span
  m='59903'>modern</span> <span m='60233'>optimizing</span> <span m='60564'>compiler</span>
  <span m='60895'>at</span> <span m='61225'>producing</span> <span m='61556'>assembly</span>
  <span m='61887'>language,</span> <span m='62217'>since</span> <span m='62548'>the</span>
  <span m='62879'>compiler</span> <span m='63303'>will</span> <span m='63727'>patiently</span>
  <span m='64151'>explore</span> <span m='64576'>alternatives</span> <span m='65000'>and</span>
  <span m='65424'>deduce</span> <span m='65848'>properties</span> <span m='66273'>of</span>
  <span m='66697'>the</span> <span m='67121'>program</span> <span m='67545'>that</span>
  <span m='67970'>may</span> <span m='68492'>not</span> <span m='69014'>be</span>
  <span m='69536'>apparent</span> <span m='70058'>to</span> <span m='70580'>even</span>
  <span m='71102'>diligent</span> <span m='71624'>assembly</span> <span m='72146'>language</span>
  <span m='72668'>programmers.</span> </p><p><span m='73190'>In</span> <span m='73558'>this</span>
  <span m='73927'>section,</span> <span m='74296'>we'll</span> <span m='74664'>look</span>
  <span m='75033'>at</span> <span m='75402'>a</span> <span m='75770'>simple</span>
  <span m='76139'>technique</span> <span m='76508'>for</span> <span m='76876'>compiling</span>
  <span m='77245'>C</span> <span m='77614'>programs</span> <span m='77982'>into</span>
  <span m='78351'>assembly.</span> </p><p><span m='78720'>Then,</span> <span m='79157'>in</span>
  <span m='79594'>the</span> <span m='80032'>next</span> <span m='80469'>section,</span>
  <span m='80906'>we'll</span> <span m='81344'>dive</span> <span m='81781'>more</span>
  <span m='82218'>deeply</span> <span m='82656'>into</span> <span m='83093'>how</span>
  <span m='83530'>a</span> <span m='83968'>modern</span> <span m='84405'>compiler</span>
  <span m='84842'>works.</span> </p><p><span m='85280'>There</span> <span m='85740'>are</span>
  <span m='86201'>two</span> <span m='86662'>main</span> <span m='87123'>routines</span>
  <span m='87584'>in</span> <span m='88045'>our</span> <span m='88505'>simple</span>
  <span m='88966'>compiler:</span> <span m='89427'>compile_statement</span> <span
  m='89888'>and</span> <span m='90349'>compile_expr.</span> </p><p><span m='90810'>The</span>
  <span m='91234'>job</span> <span m='91658'>of</span> <span m='92082'>compile_statement</span>
  <span m='92507'>is</span> <span m='92931'>to</span> <span m='93355'>compile</span>
  <span m='93780'>a</span> <span m='94204'>single</span> <span m='94628'>statement</span>
  <span m='95052'>from</span> <span m='95477'>the</span> <span m='95901'>source</span>
  <span m='96325'>program.</span> </p><p><span m='96750'>Since</span> <span m='97158'>the</span>
  <span m='97566'>source</span> <span m='97975'>program</span> <span m='98383'>is</span>
  <span m='98792'>a</span> <span m='99200'>sequence</span> <span m='99609'>of</span>
  <span m='100017'>statements,</span> <span m='100426'>we'll</span> <span m='100834'>be</span>
  <span m='101243'>calling</span> <span m='101651'>compile_statement</span> <span
  m='102060'>repeatedly.</span> <span m='102523'>We'll</span> <span m='102987'>focus</span>
  <span m='103451'>on</span> <span m='103915'>the</span> <span m='104378'>compilation</span>
  <span m='104842'>technique</span> <span m='105306'>for</span> <span m='105770'>four</span>
  <span m='106239'>types</span> <span m='106708'>of</span> <span m='107177'>statements.</span>
  <span m='107646'>An</span> <span m='108115'>unconditional</span> <span m='108584'>statement</span>
  <span m='109053'>is</span> <span m='109522'>simply</span> <span m='109991'>an</span>
  <span m='110460'>expression</span> <span m='110930'>that's</span> <span m='111389'>evaluated</span>
  <span m='111848'>once.</span> <span m='112307'>A</span> <span m='112766'>compound</span>
  <span m='113225'>statement</span> <span m='113684'>is</span> <span m='114143'>simply</span>
  <span m='114602'>a</span> <span m='115061'>sequence</span> <span m='115520'>of</span>
  <span m='115971'>statements</span> <span m='116423'>to</span> <span m='116875'>be</span>
  <span m='117326'>executed</span> <span m='117778'>in</span> <span m='118230'>turn.</span>
  <span m='118681'>Conditional</span> <span m='119133'>statements,</span> <span m='119585'>sometimes</span>
  <span m='120036'>called</span> <span m='120488'>"if</span> <span m='120940'>statements",</span>
  <span m='121304'>compute</span> <span m='121668'>the</span> <span m='122032'>value</span>
  <span m='122397'>of</span> <span m='122761'>an</span> <span m='123125'>test</span>
  <span m='123490'>expression,</span> <span m='123854'>e.g.,</span> <span m='124218'>a</span>
  <span m='124582'>comparison</span> <span m='124947'>such</span> <span m='125311'>as</span>
  <span m='125675'>"A</span> <span m='126040'></span> <span m='126419'>B".</span>
  <span m='126799'>If</span> <span m='127179'>the</span> <span m='127559'>test</span>
  <span m='127939'>is</span> <span m='128319'>true</span> <span m='128699'>then</span>
  <span m='129079'>statement_1</span> <span m='129459'>is</span> <span m='129839'>executed,</span>
  <span m='130219'>otherwise</span> <span m='130786'>statement_2</span> <span m='131353'>is</span>
  <span m='131920'>executed.</span> <span m='132488'>Iteration</span> <span m='133055'>statements</span>
  <span m='133622'>also</span> <span m='134189'>contain</span> <span m='134757'>a</span>
  <span m='135324'>test</span> <span m='135891'>expression.</span> </p><p><span m='136459'>In</span>
  <span m='136755'>each</span> <span m='137051'>iteration,</span> <span m='137347'>if</span>
  <span m='137643'>the</span> <span m='137939'>test</span> <span m='138235'>true,</span>
  <span m='138531'>then</span> <span m='138827'>the</span> <span m='139123'>statement</span>
  <span m='139419'>is</span> <span m='139715'>executed,</span> <span m='140011'>and</span>
  <span m='140307'>the</span> <span m='140603'>process</span> <span m='140900'>repeats.</span>
  <span m='141541'>If</span> <span m='142182'>the</span> <span m='142823'>test</span>
  <span m='143464'>is</span> <span m='144105'>false,</span> <span m='144746'>the</span>
  <span m='145387'>iteration</span> <span m='146028'>is</span> <span m='146669'>terminated.</span>
  </p><p><span m='147310'>The</span> <span m='147634'>other</span> <span m='147958'>main</span>
  <span m='148282'>routine</span> <span m='148607'>is</span> <span m='148931'>compile_expr</span>
  <span m='149255'>whose</span> <span m='149580'>job</span> <span m='149904'>it</span>
  <span m='150228'>is</span> <span m='150553'>to</span> <span m='150877'>generate</span>
  <span m='151201'>code</span> <span m='151526'>to</span> <span m='151850'>compute</span>
  <span m='152174'>the</span> <span m='152499'>value</span> <span m='152984'>of</span>
  <span m='153469'>an</span> <span m='153954'>expression,</span> <span m='154439'>leaving</span>
  <span m='154924'>the</span> <span m='155409'>result</span> <span m='155894'>in</span>
  <span m='156379'>some</span> <span m='156864'>register.</span> </p><p><span m='157349'>Expressions</span>
  <span m='157919'>take</span> <span m='158489'>many</span> <span m='159059'>forms:</span>
  <span m='159629'>simple</span> <span m='160199'>constant</span> <span m='160769'>values</span>
  <span m='161340'>values</span> <span m='161798'>from</span> <span m='162256'>scalar</span>
  <span m='162715'>or</span> <span m='163173'>array</span> <span m='163631'>variables,</span>
  <span m='164090'>assignment</span> <span m='164548'>expressions</span> <span m='165006'>that</span>
  <span m='165465'>compute</span> <span m='165923'>a</span> <span m='166381'>value</span>
  <span m='166840'>and</span> <span m='167255'>then</span> <span m='167670'>store</span>
  <span m='168085'>the</span> <span m='168501'>result</span> <span m='168916'>in</span>
  <span m='169331'>some</span> <span m='169746'>variable,</span> <span m='170162'>unary</span>
  <span m='170577'>or</span> <span m='170992'>binary</span> <span m='171407'>operations</span>
  <span m='171823'>that</span> <span m='172238'>combine</span> <span m='172653'>the</span>
  <span m='173069'>values</span> <span m='173561'>of</span> <span m='174054'>their</span>
  <span m='174546'>operands</span> <span m='175039'>with</span> <span m='175532'>the</span>
  <span m='176024'>specified</span> <span m='176517'>operator.</span> </p><p><span
  m='177010'>Complex</span> <span m='177462'>arithmetic</span> <span m='177914'>expressions</span>
  <span m='178366'>can</span> <span m='178819'>be</span> <span m='179271'>decomposed</span>
  <span m='179723'>into</span> <span m='180176'>sequences</span> <span m='180628'>of</span>
  <span m='181080'>unary</span> <span m='181533'>and</span> <span m='181985'>binary</span>
  <span m='182437'>operations.</span> </p><p><span m='182890'>And,</span> <span m='183299'>finally,</span>
  <span m='183709'>procedure</span> <span m='184119'>calls,</span> <span m='184529'>where</span>
  <span m='184939'>a</span> <span m='185349'>named</span> <span m='185759'>sequence</span>
  <span m='186169'>of</span> <span m='186579'>statements</span> <span m='186989'>will</span>
  <span m='187399'>be</span> <span m='187809'>executed</span> <span m='188219'>with</span>
  <span m='188629'>the</span> <span m='188942'>values</span> <span m='189255'>of</span>
  <span m='189569'>the</span> <span m='189882'>supplied</span> <span m='190195'>arguments</span>
  <span m='190509'>assigned</span> <span m='190822'>as</span> <span m='191135'>the</span>
  <span m='191449'>values</span> <span m='191762'>for</span> <span m='192075'>the</span>
  <span m='192389'>formal</span> <span m='192702'>parameters</span> <span m='193015'>of</span>
  <span m='193329'>the</span> <span m='193819'>procedure.</span> <span m='194309'>Compiling</span>
  <span m='194799'>procedures</span> <span m='195289'>and</span> <span m='195779'>procedure</span>
  <span m='196269'>calls</span> <span m='196759'>is</span> <span m='197250'>a</span>
  <span m='197617'>topic</span> <span m='197984'>that</span> <span m='198351'>we'll</span>
  <span m='198718'>tackle</span> <span m='199085'>next</span> <span m='199452'>lecture</span>
  <span m='199819'>since</span> <span m='200186'>there</span> <span m='200553'>are</span>
  <span m='200920'>some</span> <span m='201287'>complications</span> <span m='201654'>to</span>
  <span m='202021'>understand</span> <span m='202389'>and</span> <span m='202840'>deal</span>
  <span m='203291'>with.</span> <span m='203742'>Happily,</span> <span m='204193'>compiling</span>
  <span m='204644'>the</span> <span m='205095'>other</span> <span m='205546'>types</span>
  <span m='205997'>of</span> <span m='206448'>expressions</span> <span m='206900'>and</span>
  <span m='207406'>statements</span> <span m='207912'>is</span> <span m='208418'>straightforward,</span>
  <span m='208925'>so</span> <span m='209431'>let's</span> <span m='209937'>get</span>
  <span m='210443'>started.</span> </p><p><span m='210950'>What</span> <span m='211253'>code</span>
  <span m='211556'>do</span> <span m='211859'>we</span> <span m='212163'>need</span>
  <span m='212466'>to</span> <span m='212769'>put</span> <span m='213072'>the</span>
  <span m='213376'>value</span> <span m='213679'>of</span> <span m='213982'>a</span>
  <span m='214285'>constant</span> <span m='214589'>into</span> <span m='214892'>a</span>
  <span m='215195'>register?</span> </p><p><span m='215499'>If</span> <span m='215837'>the</span>
  <span m='216175'>constant</span> <span m='216513'>will</span> <span m='216851'>fit</span>
  <span m='217190'>into</span> <span m='217528'>the</span> <span m='217866'>16-bit</span>
  <span m='218204'>constant</span> <span m='218543'>field</span> <span m='218881'>of</span>
  <span m='219219'>an</span> <span m='219557'>instruction,</span> <span m='219896'>we</span>
  <span m='220234'>can</span> <span m='220572'>use</span> <span m='220910'>CMOVE</span>
  <span m='221249'>to</span> <span m='221689'>load</span> <span m='222129'>the</span>
  <span m='222569'>sign-extended</span> <span m='223009'>constant</span> <span m='223449'>into</span>
  <span m='223889'>a</span> <span m='224329'>register.</span> </p><p><span m='224769'>This</span>
  <span m='225571'>approach</span> <span m='226373'>works</span> <span m='227175'>for</span>
  <span m='227977'>constants</span> <span m='228780'>between</span> <span m='229582'>-32768</span>
  <span m='230384'>and</span> <span m='231186'>+32767.</span> </p><p><span m='231989'>If</span>
  <span m='232251'>the</span> <span m='232514'>constant</span> <span m='232777'>is</span>
  <span m='233040'>too</span> <span m='233302'>large,</span> <span m='233565'>it's</span>
  <span m='233828'>stored</span> <span m='234091'>in</span> <span m='234354'>a</span>
  <span m='234616'>main</span> <span m='234879'>memory</span> <span m='235142'>location</span>
  <span m='235405'>and</span> <span m='235667'>we</span> <span m='235930'>use</span>
  <span m='236193'>a</span> <span m='236456'>LD</span> <span m='236719'>instruction</span>
  <span m='237058'>to</span> <span m='237397'>get</span> <span m='237737'>the</span>
  <span m='238076'>value</span> <span m='238416'>into</span> <span m='238755'>a</span>
  <span m='239094'>register.</span> <span m='239434'>Loading</span> <span m='239773'>the</span>
  <span m='240113'>value</span> <span m='240452'>of</span> <span m='240791'>a</span>
  <span m='241131'>variable</span> <span m='241470'>is</span> <span m='241810'>much</span>
  <span m='242149'>the</span> <span m='242489'>same</span> <span m='242774'>as</span>
  <span m='243060'>loading</span> <span m='243345'>the</span> <span m='243631'>value</span>
  <span m='243916'>of</span> <span m='244202'>a</span> <span m='244487'>large</span>
  <span m='244773'>constant.</span> <span m='245059'>We</span> <span m='245344'>use</span>
  <span m='245630'>a</span> <span m='245915'>LD</span> <span m='246201'>instruction</span>
  <span m='246486'>to</span> <span m='246772'>access</span> <span m='247057'>the</span>
  <span m='247343'>memory</span> <span m='247629'>location</span> <span m='248094'>that</span>
  <span m='248559'>holds</span> <span m='249025'>the</span> <span m='249490'>value</span>
  <span m='249955'>of</span> <span m='250421'>the</span> <span m='250886'>variable.</span>
  <span m='251351'>Performing</span> <span m='251817'>an</span> <span m='252282'>array</span>
  <span m='252747'>access</span> <span m='253213'>is</span> <span m='253678'>slightly</span>
  <span m='254143'>more</span> <span m='254609'>complicated:</span> <span m='255051'>arrays</span>
  <span m='255493'>are</span> <span m='255936'>stored</span> <span m='256378'>as</span>
  <span m='256820'>consecutive</span> <span m='257263'>locations</span> <span m='257705'>in</span>
  <span m='258148'>main</span> <span m='258590'>memory,</span> <span m='259032'>starting</span>
  <span m='259475'>with</span> <span m='259917'>index</span> <span m='260360'>0.</span>
  <span m='260767'>Each</span> <span m='261175'>element</span> <span m='261583'>of</span>
  <span m='261991'>the</span> <span m='262398'>array</span> <span m='262806'>occupies</span>
  <span m='263214'>some</span> <span m='263622'>fixed</span> <span m='264030'>number</span>
  <span m='264441'>bytes.</span> <span m='264853'>So</span> <span m='265265'>we</span>
  <span m='265677'>need</span> <span m='266089'>code</span> <span m='266500'>to</span>
  <span m='266912'>convert</span> <span m='267324'>the</span> <span m='267736'>array</span>
  <span m='268148'>index</span> <span m='268560'>into</span> <span m='269057'>the</span>
  <span m='269554'>actual</span> <span m='270051'>main</span> <span m='270549'>memory</span>
  <span m='271046'>address</span> <span m='271543'>for</span> <span m='272040'>the</span>
  <span m='272538'>specified</span> <span m='273035'>array</span> <span m='273532'>element.</span>
  </p><p><span m='274030'>We</span> <span m='274427'>first</span> <span m='274825'>invoke</span>
  <span m='275223'>compile_expr</span> <span m='275621'>to</span> <span m='276019'>generate</span>
  <span m='276417'>code</span> <span m='276815'>that</span> <span m='277212'>evaluates</span>
  <span m='277610'>the</span> <span m='278008'>index</span> <span m='278406'>expression</span>
  <span m='278804'>and</span> <span m='279202'>leaves</span> <span m='279600'>the</span>
  <span m='279992'>result</span> <span m='280385'>in</span> <span m='280778'>Rx.</span>
  <span m='281171'>That</span> <span m='281564'>will</span> <span m='281957'>be</span>
  <span m='282350'>a</span> <span m='282742'>value</span> <span m='283135'>between</span>
  <span m='283528'>0</span> <span m='283921'>and</span> <span m='284314'>the</span>
  <span m='284707'>size</span> <span m='285100'>of</span> <span m='285490'>the</span>
  <span m='285880'>array</span> <span m='286270'>minus</span> <span m='286660'>1.</span>
  <span m='287050'>We'll</span> <span m='287440'>use</span> <span m='287830'>a</span>
  <span m='288220'>LD</span> <span m='288610'>instruction</span> <span m='289000'>to</span>
  <span m='289390'>access</span> <span m='289780'>the</span> <span m='290170'>appropriate</span>
  <span m='290560'>array</span> <span m='290817'>entry,</span> <span m='291074'>but</span>
  <span m='291331'>that</span> <span m='291588'>means</span> <span m='291846'>we</span>
  <span m='292103'>need</span> <span m='292360'>to</span> <span m='292617'>convert</span>
  <span m='292875'>the</span> <span m='293132'>index</span> <span m='293389'>into</span>
  <span m='293646'>a</span> <span m='293903'>byte</span> <span m='294161'>offset,</span>
  <span m='294418'>which</span> <span m='294675'>we</span> <span m='294932'>do</span>
  <span m='295190'>by</span> <span m='295641'>multiplying</span> <span m='296093'>the</span>
  <span m='296544'>index</span> <span m='296996'>by</span> <span m='297447'>bsize,</span>
  <span m='297899'>the</span> <span m='298350'>number</span> <span m='298802'>of</span>
  <span m='299253'>bytes</span> <span m='299705'>in</span> <span m='300156'>one</span>
  <span m='300608'>element.</span> </p><p><span m='301060'>If</span> <span m='301499'>b</span>
  <span m='301938'>was</span> <span m='302377'>an</span> <span m='302816'>array</span>
  <span m='303255'>of</span> <span m='303694'>integers,</span> <span m='304133'>bsize</span>
  <span m='304572'>would</span> <span m='305011'>be</span> <span m='305450'>4.</span>
  </p><p><span m='305890'>Now</span> <span m='306138'>that</span> <span m='306386'>we</span>
  <span m='306634'>have</span> <span m='306882'>the</span> <span m='307130'>byte</span>
  <span m='307378'>offset</span> <span m='307626'>in</span> <span m='307874'>a</span>
  <span m='308122'>register,</span> <span m='308370'>we</span> <span m='308619'>can</span>
  <span m='308867'>use</span> <span m='309115'>LD</span> <span m='309363'>to</span>
  <span m='309611'>add</span> <span m='309859'>the</span> <span m='310107'>offset</span>
  <span m='310355'>to</span> <span m='310603'>the</span> <span m='310851'>base</span>
  <span m='311100'>address</span> <span m='311438'>of</span> <span m='311776'>the</span>
  <span m='312114'>array</span> <span m='312452'>computing</span> <span m='312790'>the</span>
  <span m='313128'>address</span> <span m='313466'>of</span> <span m='313804'>the</span>
  <span m='314142'>desired</span> <span m='314480'>array</span> <span m='314818'>element,</span>
  <span m='315156'>then</span> <span m='315494'>load</span> <span m='315832'>the</span>
  <span m='316170'>memory</span> <span m='316666'>value</span> <span m='317163'>at</span>
  <span m='317660'>that</span> <span m='318156'>address</span> <span m='318653'>into</span>
  <span m='319150'>a</span> <span m='319646'>register.</span> <span m='320143'>Assignment</span>
  <span m='320640'>expressions</span> <span m='321136'>are</span> <span m='321633'>easy</span>
  <span m='322130'>Invoke</span> <span m='322518'>compile_expr</span> <span m='322906'>to</span>
  <span m='323294'>generate</span> <span m='323682'>code</span> <span m='324070'>that</span>
  <span m='324458'>loads</span> <span m='324846'>the</span> <span m='325234'>value</span>
  <span m='325622'>of</span> <span m='326010'>the</span> <span m='326398'>expression</span>
  <span m='326786'>into</span> <span m='327174'>a</span> <span m='327562'>register,</span>
  <span m='327950'>then</span> <span m='328426'>generate</span> <span m='328902'>a</span>
  <span m='329378'>ST</span> <span m='329854'>instruction</span> <span m='330330'>to</span>
  <span m='330806'>store</span> <span m='331283'>the</span> <span m='331759'>value</span>
  <span m='332235'>into</span> <span m='332711'>the</span> <span m='333187'>specified</span>
  <span m='333663'>variable.</span> </p><p><span m='334140'>Arithmetic</span> <span
  m='334505'>operations</span> <span m='334870'>are</span> <span m='335236'>pretty</span>
  <span m='335601'>easy</span> <span m='335966'>too.</span> <span m='336332'>Use</span>
  <span m='336697'>compile_expr</span> <span m='337063'>to</span> <span m='337428'>generate</span>
  <span m='337793'>code</span> <span m='338159'>for</span> <span m='338524'>each</span>
  <span m='338890'>of</span> <span m='339297'>the</span> <span m='339705'>operand</span>
  <span m='340113'>expressions,</span> <span m='340521'>leaving</span> <span m='340928'>the</span>
  <span m='341336'>results</span> <span m='341744'>in</span> <span m='342152'>registers.</span>
  </p><p><span m='342560'>Then</span> <span m='343013'>generate</span> <span m='343467'>the</span>
  <span m='343920'>appropriate</span> <span m='344374'>ALU</span> <span m='344827'>instruction</span>
  <span m='345281'>to</span> <span m='345734'>combine</span> <span m='346188'>the</span>
  <span m='346641'>operands</span> <span m='347095'>and</span> <span m='347548'>leave</span>
  <span m='348002'>the</span> <span m='348455'>answer</span> <span m='348909'>in</span>
  <span m='349213'>a</span> <span m='349517'>register.</span> <span m='349821'>Let's</span>
  <span m='350126'>look</span> <span m='350430'>at</span> <span m='350734'>example</span>
  <span m='351038'>to</span> <span m='351343'>see</span> <span m='351647'>how</span>
  <span m='351951'>all</span> <span m='352255'>this</span> <span m='352560'>works.</span>
  <span m='352978'>Here</span> <span m='353397'>have</span> <span m='353815'>an</span>
  <span m='354234'>assignment</span> <span m='354653'>expression</span> <span m='355071'>that</span>
  <span m='355490'>requires</span> <span m='355909'>a</span> <span m='356367'>subtract,</span>
  <span m='356825'>a</span> <span m='357284'>multiply,</span> <span m='357742'>and</span>
  <span m='358201'>an</span> <span m='358659'>addition</span> <span m='359117'>to</span>
  <span m='359576'>compute</span> <span m='360034'>the</span> <span m='360493'>required</span>
  <span m='360951'>value.</span> </p><p><span m='361410'>Let's</span> <span m='361767'>follow</span>
  <span m='362125'>the</span> <span m='362483'>compilation</span> <span m='362840'>process</span>
  <span m='363198'>from</span> <span m='363556'>start</span> <span m='363913'>to</span>
  <span m='364271'>finish</span> <span m='364629'>as</span> <span m='364986'>we</span>
  <span m='365344'>invoke</span> <span m='365702'>compile_expr</span> <span m='366060'>to</span>
  <span m='366506'>generate</span> <span m='366952'>the</span> <span m='367399'>necessary</span>
  <span m='367845'>code.</span> <span m='368291'>Following</span> <span m='368738'>the</span>
  <span m='369184'>template</span> <span m='369630'>for</span> <span m='370077'>assignment</span>
  <span m='370523'>expressions</span> <span m='370970'>from</span> <span m='371390'>the</span>
  <span m='371810'>previous</span> <span m='372230'>page,</span> <span m='372650'>we</span>
  <span m='373070'>recursively</span> <span m='373490'>call</span> <span m='373910'>compile_expr</span>
  <span m='374330'>to</span> <span m='374750'>compute</span> <span m='375170'>value</span>
  <span m='375590'>of</span> <span m='376010'>the</span> <span m='376430'>right-hand-side</span>
  <span m='376850'>of</span> <span m='377355'>the</span> <span m='377861'>assignment.</span>
  <span m='378367'>That's</span> <span m='378872'>a</span> <span m='379378'>multiply</span>
  <span m='379884'>operation,</span> <span m='380389'>so,</span> <span m='380895'>following</span>
  <span m='381401'>the</span> <span m='381851'>Operations</span> <span m='382302'>template,</span>
  <span m='382753'>we</span> <span m='383203'>need</span> <span m='383654'>to</span>
  <span m='384105'>compile</span> <span m='384555'>the</span> <span m='385006'>left-hand</span>
  <span m='385457'>operand</span> <span m='385907'>of</span> <span m='386358'>the</span>
  <span m='386809'>multiply.</span> </p><p><span m='387260'>That's</span> <span m='387657'>a</span>
  <span m='388054'>subtract</span> <span m='388452'>operation,</span> <span m='388849'>so,</span>
  <span m='389246'>we</span> <span m='389644'>call</span> <span m='390041'>compile_expr</span>
  <span m='390438'>again</span> <span m='390836'>to</span> <span m='391233'>compile</span>
  <span m='391630'>the</span> <span m='392028'>left-hand</span> <span m='392425'>operand</span>
  <span m='392822'>of</span> <span m='393220'>the</span> <span m='393587'>subtract.</span>
  <span m='393955'>Aha,</span> <span m='394323'>we</span> <span m='394690'>know</span>
  <span m='395058'>how</span> <span m='395426'>to</span> <span m='395793'>get</span>
  <span m='396161'>the</span> <span m='396529'>value</span> <span m='396896'>of</span>
  <span m='397264'>a</span> <span m='397632'>variable</span> <span m='398000'>into</span>
  <span m='398407'>a</span> <span m='398815'>register.</span> <span m='399222'>So</span>
  <span m='399630'>we</span> <span m='400038'>generate</span> <span m='400445'>a</span>
  <span m='400853'>LD</span> <span m='401261'>instruction</span> <span m='401668'>to</span>
  <span m='402076'>load</span> <span m='402484'>the</span> <span m='402891'>value</span>
  <span m='403299'>of</span> <span m='403707'>x</span> <span m='404114'>into</span>
  <span m='404522'>r1.</span> </p><p><span m='404930'>The</span> <span m='405422'>process</span>
  <span m='405915'>we're</span> <span m='406407'>following</span> <span m='406900'>is</span>
  <span m='407392'>called</span> <span m='407885'>"recursive</span> <span m='408377'>descent".</span>
  </p><p><span m='408870'>We've</span> <span m='409272'>used</span> <span m='409674'>recursive</span>
  <span m='410076'>calls</span> <span m='410478'>to</span> <span m='410880'>compile_expr</span>
  <span m='411282'>to</span> <span m='411685'>process</span> <span m='412087'>each</span>
  <span m='412489'>level</span> <span m='412891'>of</span> <span m='413293'>the</span>
  <span m='413695'>expression</span> <span m='414097'>tree.</span> </p><p><span m='414500'>At</span>
  <span m='414888'>each</span> <span m='415277'>recursive</span> <span m='415666'>call</span>
  <span m='416054'>the</span> <span m='416443'>expressions</span> <span m='416832'>get</span>
  <span m='417220'>simpler,</span> <span m='417609'>until</span> <span m='417998'>we</span>
  <span m='418386'>reach</span> <span m='418775'>a</span> <span m='419164'>variable</span>
  <span m='419552'>or</span> <span m='419941'>constant,</span> <span m='420330'>where</span>
  <span m='420812'>we</span> <span m='421294'>can</span> <span m='421776'>generate</span>
  <span m='422258'>the</span> <span m='422740'>appropriate</span> <span m='423222'>instruction</span>
  <span m='423704'>without</span> <span m='424186'>descending</span> <span m='424668'>further.</span>
  </p><p><span m='425150'>At</span> <span m='425424'>this</span> <span m='425699'>point</span>
  <span m='425974'>we've</span> <span m='426248'>reach</span> <span m='426523'>a</span>
  <span m='426798'>leaf</span> <span m='427073'>of</span> <span m='427347'>the</span>
  <span m='427622'>expression</span> <span m='427897'>tree</span> <span m='428172'>and</span>
  <span m='428446'>we're</span> <span m='428721'>done</span> <span m='428996'>with</span>
  <span m='429271'>this</span> <span m='429545'>branch</span> <span m='429820'>of</span>
  <span m='430095'>the</span> <span m='430370'>recursion.</span> <span m='430702'>Now</span>
  <span m='431035'>we</span> <span m='431368'>need</span> <span m='431700'>to</span>
  <span m='432033'>get</span> <span m='432366'>the</span> <span m='432699'>value</span>
  <span m='433031'>of</span> <span m='433364'>the</span> <span m='433697'>right-hand</span>
  <span m='434030'>operand</span> <span m='434406'>of</span> <span m='434783'>the</span>
  <span m='435160'>subtract</span> <span m='435537'>into</span> <span m='435914'>a</span>
  <span m='436291'>register.</span> <span m='436668'>In</span> <span m='437045'>case</span>
  <span m='437421'>it's</span> <span m='437798'>a</span> <span m='438175'>small</span>
  <span m='438552'>constant,</span> <span m='438929'>so</span> <span m='439306'>we</span>
  <span m='439683'>generate</span> <span m='440060'>a</span> <span m='440572'>CMOVE</span>
  <span m='441085'>instruction.</span> <span m='441598'>Now</span> <span m='442110'>that</span>
  <span m='442623'>both</span> <span m='443136'>operand</span> <span m='443649'>values</span>
  <span m='444161'>are</span> <span m='444674'>in</span> <span m='445187'>registers,</span>
  <span m='445700'>we</span> <span m='446117'>return</span> <span m='446534'>to</span>
  <span m='446952'>the</span> <span m='447369'>subtract</span> <span m='447786'>template</span>
  <span m='448204'>and</span> <span m='448621'>generate</span> <span m='449038'>a</span>
  <span m='449456'>SUB</span> <span m='449873'>instruction</span> <span m='450290'>to</span>
  <span m='450708'>do</span> <span m='451125'>the</span> <span m='451542'>subtraction.</span>
  </p><p><span m='451960'>We</span> <span m='452405'>now</span> <span m='452851'>have</span>
  <span m='453297'>the</span> <span m='453742'>value</span> <span m='454188'>for</span>
  <span m='454634'>the</span> <span m='455080'>left-hand</span> <span m='455525'>operand</span>
  <span m='455971'>of</span> <span m='456417'>the</span> <span m='456862'>multiply</span>
  <span m='457308'>in</span> <span m='457754'>r1.</span> </p><p><span m='458200'>We</span>
  <span m='458568'>follow</span> <span m='458937'>the</span> <span m='459305'>same</span>
  <span m='459674'>process</span> <span m='460042'>for</span> <span m='460411'>the</span>
  <span m='460780'>right-hand</span> <span m='461148'>operand</span> <span m='461517'>of</span>
  <span m='461885'>the</span> <span m='462254'>multiply,</span> <span m='462622'>recursively</span>
  <span m='462991'>calling</span> <span m='463360'>compile_expr</span> <span m='463794'>to</span>
  <span m='464228'>process</span> <span m='464662'>each</span> <span m='465096'>level</span>
  <span m='465530'>of</span> <span m='465964'>the</span> <span m='466398'>expression</span>
  <span m='466832'>until</span> <span m='467266'>we</span> <span m='467700'>reach</span>
  <span m='468134'>a</span> <span m='468568'>variable</span> <span m='469002'>or</span>
  <span m='469436'>constant.</span> </p><p><span m='469870'>Then</span> <span m='470249'>we</span>
  <span m='470628'>return</span> <span m='471008'>up</span> <span m='471387'>the</span>
  <span m='471767'>expression</span> <span m='472146'>tree,</span> <span m='472525'>generating</span>
  <span m='472905'>the</span> <span m='473284'>appropriate</span> <span m='473664'>instructions</span>
  <span m='474043'>as</span> <span m='474422'>we</span> <span m='474802'>go,</span>
  <span m='475181'>following</span> <span m='475561'>the</span> <span m='476010'>dictates</span>
  <span m='476460'>of</span> <span m='476910'>the</span> <span m='477360'>appropriate</span>
  <span m='477810'>template</span> <span m='478260'>from</span> <span m='478710'>the</span>
  <span m='479160'>previous</span> <span m='479610'>slide.</span> </p><p><span m='480060'>The</span>
  <span m='480346'>generated</span> <span m='480632'>code</span> <span m='480919'>is</span>
  <span m='481205'>shown</span> <span m='481491'>on</span> <span m='481778'>the</span>
  <span m='482064'>left</span> <span m='482350'>of</span> <span m='482637'>the</span>
  <span m='482923'>slide.</span> </p><p><span m='483210'>The</span> <span m='483533'>recursive-descent</span>
  <span m='483857'>technique</span> <span m='484181'>makes</span> <span m='484505'>short</span>
  <span m='484829'>work</span> <span m='485153'>of</span> <span m='485476'>generating</span>
  <span m='485800'>code</span> <span m='486124'>for</span> <span m='486448'>even</span>
  <span m='486772'>the</span> <span m='487096'>most</span> <span m='487420'>complicated</span>
  <span m='487937'>of</span> <span m='488454'>expressions.</span> <span m='488971'>There's</span>
  <span m='489488'>even</span> <span m='490005'>opportunity</span> <span m='490522'>to</span>
  <span m='491039'>find</span> <span m='491556'>some</span> <span m='492073'>simple</span>
  <span m='492590'>optimizations</span> <span m='493040'>by</span> <span m='493491'>looking</span>
  <span m='493942'>at</span> <span m='494392'>adjacent</span> <span m='494843'>instructions.</span>
  <span m='495294'>For</span> <span m='495745'>example,</span> <span m='496195'>a</span>
  <span m='496646'>CMOVE</span> <span m='497097'>followed</span> <span m='497547'>by</span>
  <span m='497998'>an</span> <span m='498449'>arithmetic</span> <span m='498900'>operation</span>
  <span m='499250'>can</span> <span m='499601'>often</span> <span m='499952'>be</span>
  <span m='500302'>shorted</span> <span m='500653'>to</span> <span m='501004'>a</span>
  <span m='501355'>single</span> <span m='501705'>arithmetic</span> <span m='502056'>instruction</span>
  <span m='502407'>with</span> <span m='502757'>the</span> <span m='503108'>constant</span>
  <span m='503459'>as</span> <span m='503810'>its</span> <span m='504294'>second</span>
  <span m='504778'>operand.</span> <span m='505263'>These</span> <span m='505747'>local</span>
  <span m='506232'>transformations</span> <span m='506716'>are</span> <span m='507201'>called</span>
  <span m='507685'>"peephole</span> <span m='508170'>optimizations"</span> <span m='508499'>since</span>
  <span m='508828'>we're</span> <span m='509157'>only</span> <span m='509486'>considering</span>
  <span m='509815'>just</span> <span m='510144'>one</span> <span m='510473'>or</span>
  <span m='510802'>two</span> <span m='511131'>instructions</span> <span m='511460'>at</span>
  <span m='511789'>a</span> <span m='512118'>time.</span> </p>
type: course
uid: cb34fd077ec52ee1979a08a2df3bdcfe

---
None